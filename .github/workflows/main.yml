name: Vue Frontend CI/CD

on:
    push:
        branches: [main]

env:
    AWS_REGION: us-east-1
    ECR_REPOSITORY: cool-admin-vue
    CODEDEPLOY_APP: CoolAdminApp
    CODEDEPLOY_GROUP: Vue-Group

jobs:
    build-and-deploy:
        runs-on: self-hosted
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            # 1. 在宿主机安装依赖并打包 (利用宿主机的 Swap)
            - name: Install and Build on Host
              run: |
                  # 设置 pnpm 镜像
                  if ! command -v pnpm &> /dev/null; then
                    sudo npm install -g pnpm
                  fi

                  # 给予 Node 充足的堆内存限制 (2GB)
                  export NODE_OPTIONS="--max-old-space-size=2048"

                  pnpm install --frozen-lockfile
                  pnpm run build

            # 2. 登录 ECR
            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            # 3. 构建 Docker 镜像 (此时 Dockerfile 只是简单的 COPY dist)
            - name: Build and Push Image
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                  IMAGE_TAG: ${{ github.sha }}
              run: |
                  docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
                  docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
                  docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
                  docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

            # 4. 触发 CodeDeploy
            - name: Trigger CodeDeploy
              run: |
                  aws deploy create-deployment \
                    --application-name ${{ env.CODEDEPLOY_APP }} \
                    --deployment-group-name ${{ env.CODEDEPLOY_GROUP }} \
                    --github-location repository=${{ github.repository }},commitId=${{ github.sha }} \
                    --description "IMAGE_TAG=${{ steps.build-image.outputs.image_tag }}"
