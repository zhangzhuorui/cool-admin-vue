name: Vue Frontend CI/CD

on:
    push:
        branches: [main]

env:
    AWS_REGION: us-east-1 # 确认你的新区域！
    ECR_REPOSITORY: cool-admin-vue
    CODEDEPLOY_APP: CoolAdminApp # 确认你的新应用名！
    CODEDEPLOY_GROUP: Vue-Group

jobs:
    build-and-deploy:
        runs-on: self-hosted
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Install and Build on Host
              run: |
                  corepack enable
                  pnpm install --frozen-lockfile
                  export NODE_OPTIONS="--max-old-space-size=2048"
                  pnpm run build

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            - name: Build, Tag, and Push Image
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                  IMAGE_TAG: ${{ github.sha }}
              run: |
                  # 这一步会去找 dist 文件夹
                  docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
                  docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
                  docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
                  docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

            - name: Trigger CodeDeploy
              run: |
                  aws deploy create-deployment \
                    --application-name ${{ env.CODEDEPLOY_APP }} \
                    --deployment-group-name ${{ env.CODEDEPLOY_GROUP }} \
                    --github-location repository=${{ github.repository }},commitId=${{ github.sha }} \
                    --description "IMAGE_TAG=${{ github.sha }}"
