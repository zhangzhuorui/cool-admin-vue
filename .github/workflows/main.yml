name: Vue Frontend CI/CD

on:
    push:
        branches: [main]

env:
    AWS_REGION: us-east-1
    ECR_REPOSITORY: cool-admin-vue
    CODEDEPLOY_APP: CoolAdminVue
    CODEDEPLOY_GROUP: Vue-Group

jobs:
    build-and-deploy:
        runs-on: self-hosted
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            # 1. 编译前端项目 (pnpm 版)
            - name: Install and Build
              run: |
                  # 1. 强制设置 Node.js 堆内存上限为 2048MB (2GB)
                  # 注意：这需要你已经按照之前的建议开启了 2GB 的 Swap
                  export NODE_OPTIONS="--max-old-space-size=2048"

                  # 2. 安装 pnpm (如果没装)
                  if ! command -v pnpm &> /dev/null; then
                    sudo npm install -g pnpm
                  fi

                  # 3. 安装依赖 (使用低内存模式)
                  pnpm install

                  # 4. 执行编译
                  pnpm run build

            # 2. 登录 AWS ECR
            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            # 3. 构建并推送 Docker 镜像
            - name: Build, Tag, and Push Image
              id: build-image
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                  IMAGE_TAG: ${{ github.sha }}
              run: |
                  docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
                  docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
                  docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
                  docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
                  echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

            # 4. 触发 CodeDeploy
            - name: Trigger CodeDeploy
              run: |
                  aws deploy create-deployment \
                    --application-name ${{ env.CODEDEPLOY_APP }} \
                    --deployment-group-name ${{ env.CODEDEPLOY_GROUP }} \
                    --github-location repository=${{ github.repository }},commitId=${{ github.sha }} \
                    --description "IMAGE_TAG=${{ steps.build-image.outputs.image_tag }}"
